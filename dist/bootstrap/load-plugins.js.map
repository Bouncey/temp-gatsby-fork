{"version":3,"sources":["../../src/bootstrap/load-plugins.js"],"names":["_","require","slash","fs","path","crypto","glob","store","nodeAPIs","testRequireError","report","createFileContentHash","root","globPattern","hash","createHash","files","sync","nodir","forEach","filepath","update","readFileSync","digest","resolvePlugin","pluginName","existsSync","resolvedPath","resolve","packageJSON","JSON","parse","name","id","version","Error","dirname","err","module","exports","config","plugins","processPlugin","plugin","isString","info","pluginOptions","subplugins","options","p","push","merge","join","__dirname","process","cwd","flattenedPlugins","extractPlugins","subPlugin","apis","keys","apiToPlugins","reduce","acc","value","badExports","gatsbyNode","panic","gatsbyNodeKeys","intersection","map","nodeAPI","concat","difference","e","exportName","pluginVersion","length","stringSimiliarity","stripIndent","console","log","bady","similarities","findBestMatch","message","bestMatch","rating","target","exit","dispatch","type","payload"],"mappings":"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","file":"load-plugins.js","sourcesContent":["const _ = require(`lodash`)\nconst slash = require(`slash`)\nconst fs = require(`fs`)\nconst path = require(`path`)\nconst crypto = require(`crypto`)\nconst glob = require(`glob`)\n\nconst { store } = require(`../redux`)\nconst nodeAPIs = require(`../utils/api-node-docs`)\nconst testRequireError = require(`../utils/test-require-error`)\nconst report = require(`gatsby-cli/lib/reporter`)\n\nfunction createFileContentHash(root, globPattern) {\n  const hash = crypto.createHash(`md5`)\n  const files = glob.sync(`${root}/${globPattern}`, { nodir: true })\n\n  files.forEach(filepath => {\n    hash.update(fs.readFileSync(filepath))\n  })\n\n  return hash.digest(`hex`)\n}\n\n/**\n * @typedef {Object} PluginInfo\n * @property {string} resolve The absolute path to the plugin\n * @property {string} name The plugin name\n * @property {string} version The plugin version (can be content hash)\n */\n\n/**\n * resolvePlugin\n * @param {string} pluginName\n * This can be a name of a local plugin, the name of a plugin located in\n * node_modules, or a Gatsby internal plugin. In the last case the pluginName\n * will be an absolute path.\n * @return {PluginInfo}\n */\nfunction resolvePlugin(pluginName) {\n  // Only find plugins when we're not given an absolute path\n  if (!fs.existsSync(pluginName)) {\n    // Find the plugin in the local plugins folder\n    const resolvedPath = slash(path.resolve(`./plugins/${pluginName}`))\n\n    if (fs.existsSync(resolvedPath)) {\n      if (fs.existsSync(`${resolvedPath}/package.json`)) {\n        const packageJSON = JSON.parse(\n          fs.readFileSync(`${resolvedPath}/package.json`, `utf-8`)\n        )\n\n        return {\n          resolve: resolvedPath,\n          name: packageJSON.name || pluginName,\n          id: `Plugin ${packageJSON.name || pluginName}`,\n          version:\n            packageJSON.version || createFileContentHash(resolvedPath, `**`),\n        }\n      } else {\n        // Make package.json a requirement for local plugins too\n        throw new Error(`Plugin ${pluginName} requires a package.json file`)\n      }\n    }\n  }\n\n  /**\n   * Here we have an absolute path to an internal plugin, or a name of a module\n   * which should be located in node_modules.\n   */\n  try {\n    const resolvedPath = slash(path.dirname(require.resolve(pluginName)))\n\n    const packageJSON = JSON.parse(\n      fs.readFileSync(`${resolvedPath}/package.json`, `utf-8`)\n    )\n\n    return {\n      resolve: resolvedPath,\n      id: `Plugin ${packageJSON.name}`,\n      name: packageJSON.name,\n      version: packageJSON.version,\n    }\n  } catch (err) {\n    throw new Error(`Unable to find plugin \"${pluginName}\"`)\n  }\n}\n\nmodule.exports = async (config = {}) => {\n  // Instantiate plugins.\n  const plugins = []\n\n  // Create fake little site with a plugin for testing this\n  // w/ snapshots. Move plugin processing to its own module.\n  // Also test adding to redux store.\n  const processPlugin = plugin => {\n    if (_.isString(plugin)) {\n      const info = resolvePlugin(plugin)\n\n      return {\n        ...info,\n        pluginOptions: {\n          plugins: [],\n        },\n      }\n    } else {\n      // Plugins can have plugins.\n      const subplugins = []\n      if (plugin.options && plugin.options.plugins) {\n        plugin.options.plugins.forEach(p => {\n          subplugins.push(processPlugin(p))\n        })\n\n        plugin.options.plugins = subplugins\n      }\n\n      // Add some default values for tests as we don't actually\n      // want to try to load anything during tests.\n      if (plugin.resolve === `___TEST___`) {\n        return {\n          name: `TEST`,\n          pluginOptions: {\n            plugins: [],\n          },\n        }\n      }\n\n      const info = resolvePlugin(plugin.resolve)\n\n      return {\n        ...info,\n        pluginOptions: _.merge({ plugins: [] }, plugin.options),\n      }\n    }\n  }\n\n  // Add internal plugins\n  plugins.push(\n    processPlugin(\n      path.join(__dirname, `../internal-plugins/component-page-creator`)\n    )\n  )\n  plugins.push(\n    processPlugin(\n      path.join(__dirname, `../internal-plugins/component-layout-creator`)\n    )\n  )\n  plugins.push(\n    processPlugin(\n      path.join(__dirname, `../internal-plugins/internal-data-bridge`)\n    )\n  )\n  plugins.push(\n    processPlugin(path.join(__dirname, `../internal-plugins/dev-404-page`))\n  )\n  plugins.push(\n    processPlugin(path.join(__dirname, `../internal-plugins/prod-404`))\n  )\n  plugins.push(\n    processPlugin(path.join(__dirname, `../internal-plugins/query-runner`))\n  )\n\n  // Add plugins from the site config.\n  if (config.plugins) {\n    config.plugins.forEach(plugin => {\n      plugins.push(processPlugin(plugin))\n    })\n  }\n\n  // Add the site's default \"plugin\" i.e. gatsby-x files in root of site.\n  plugins.push({\n    resolve: slash(process.cwd()),\n    id: `Plugin default-site-plugin`,\n    name: `default-site-plugin`,\n    version: createFileContentHash(process.cwd(), `gatsby-*`),\n    pluginOptions: {\n      plugins: [],\n    },\n  })\n\n  // Create a \"flattened\" array of plugins with all subplugins\n  // brought to the top-level. This simplifies running gatsby-* files\n  // for subplugins.\n  const flattenedPlugins = []\n  const extractPlugins = plugin => {\n    plugin.pluginOptions.plugins.forEach(subPlugin => {\n      flattenedPlugins.push(subPlugin)\n      extractPlugins(subPlugin)\n    })\n  }\n\n  plugins.forEach(plugin => {\n    flattenedPlugins.push(plugin)\n    extractPlugins(plugin)\n  })\n\n  // Validate plugins before saving. Plugins can only export known APIs. The known\n  // APIs that a plugin supports are saved along with the plugin in the store for\n  // easier filtering later. If there are bad exports (either typos, outdated, or\n  // plain incorrect), then we output a readable error & quit.\n  const apis = _.keys(nodeAPIs)\n  const apiToPlugins = apis.reduce((acc, value) => {\n    acc[value] = []\n    return acc\n  }, {})\n  let badExports = []\n  flattenedPlugins.forEach(plugin => {\n    let gatsbyNode\n    plugin.nodeAPIs = []\n    try {\n      gatsbyNode = require(`${plugin.resolve}/gatsby-node`)\n    } catch (err) {\n      if (!testRequireError(`gatsby-node`, err)) {\n        // ignore\n      } else {\n        report.panic(`Error requiring ${plugin.resolve}/gatsby-node.js`, err)\n      }\n    }\n\n    if (gatsbyNode) {\n      const gatsbyNodeKeys = _.keys(gatsbyNode)\n      // Discover which nodeAPIs this plugin implements and store\n      // an array against the plugin node itself *and* in a node\n      // API to plugins map for faster lookups later.\n      plugin.nodeAPIs = _.intersection(gatsbyNodeKeys, apis)\n      plugin.nodeAPIs.map(nodeAPI => apiToPlugins[nodeAPI].push(plugin.name))\n      // Discover any exports from plugins which are not \"known\"\n      badExports = badExports.concat(\n        _.difference(gatsbyNodeKeys, apis).map(e => {\n          return {\n            exportName: e,\n            pluginName: plugin.name,\n            pluginVersion: plugin.version,\n          }\n        })\n      )\n    }\n  })\n\n  if (badExports.length > 0) {\n    const stringSimiliarity = require(`string-similarity`)\n    const { stripIndent } = require(`common-tags`)\n    console.log(`\\n`)\n    console.log(\n      stripIndent`\n      Your plugins must export known APIs from their gatsby-node.js.\n      The following exports aren't APIs. Perhaps you made a typo or\n      your plugin is outdated?\n\n      See https://www.gatsbyjs.org/docs/node-apis/ for the list of Gatsby Node APIs`\n    )\n    badExports.forEach(bady => {\n      const similarities = stringSimiliarity.findBestMatch(\n        bady.exportName,\n        apis\n      )\n      let message = `\\n â€” `\n      if (bady.pluginName == `default-site-plugin`) {\n        message += `Your site's gatsby-node.js is exporting a variable named \"${\n          bady.exportName\n        }\" which isn't an API.`\n      } else {\n        message += `The plugin \"${bady.pluginName}@${\n          bady.pluginVersion\n        }\" is exporting a variable named \"${\n          bady.exportName\n        }\" which isn't an API.`\n      }\n      if (similarities.bestMatch.rating > 0.5) {\n        message += ` Perhaps you meant to export \"${\n          similarities.bestMatch.target\n        }\"?`\n      }\n\n      console.log(message)\n    })\n    process.exit()\n  }\n\n  store.dispatch({\n    type: `SET_SITE_PLUGINS`,\n    payload: plugins,\n  })\n\n  store.dispatch({\n    type: `SET_SITE_FLATTENED_PLUGINS`,\n    payload: flattenedPlugins,\n  })\n\n  store.dispatch({\n    type: `SET_SITE_API_TO_PLUGINS`,\n    payload: apiToPlugins,\n  })\n\n  return flattenedPlugins\n}\n"]}